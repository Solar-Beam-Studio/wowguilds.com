generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// Better Auth models
// ============================================================================

model User {
  id            String    @id @default(cuid())
  name          String
  email         String    @unique
  emailVerified Boolean   @default(false)
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  sessions Session[]
  accounts Account[]
  guilds   Guild[]

  @@map("users")
}

model Session {
  id        String   @id @default(cuid())
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model Account {
  id                    String    @id @default(cuid())
  accountId             String
  providerId            String
  userId                String
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("accounts")
}

model Verification {
  id         String    @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime? @default(now())
  updatedAt  DateTime? @updatedAt

  @@map("verifications")
}

// ============================================================================
// Guild models
// ============================================================================

model Guild {
  id                     String    @id @default(cuid())
  name                   String
  realm                  String
  region                 String
  syncEnabled            Boolean   @default(true)
  discoveryIntervalHours Int       @default(6)
  activeSyncIntervalMin  Int       @default(30)
  activityWindowDays     Int       @default(30)
  memberCount            Int       @default(0)
  lastDiscoveryAt        DateTime?
  lastActiveSyncAt       DateTime?
  userId                 String?
  crestEmblemId          Int?
  crestEmblemColor       String?   // "r,g,b,a"
  crestBorderId          Int?
  crestBorderColor       String?   // "r,g,b,a"
  crestBgColor           String?   // "r,g,b,a"
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt

  user       User?         @relation(fields: [userId], references: [id], onDelete: SetNull)
  members    GuildMember[]
  syncJobs   SyncJob[]
  syncErrors SyncError[]
  syncLogs   SyncLog[]

  @@unique([name, realm, region])
  @@index([userId])
  @@map("guilds")
}

// ============================================================================
// Sync data models
// ============================================================================

model GuildMember {
  id                     Int       @id @default(autoincrement())
  guildId                String
  characterName          String
  realm                  String
  characterClass         String?
  level                  Int?
  itemLevel              Float?
  mythicPlusScore        Float?
  currentSeason          String?
  pvp2v2Rating           Int       @default(0)
  pvp3v3Rating           Int       @default(0)
  pvpRbgRating           Int       @default(0)
  soloShuffleRating      Int       @default(0)
  maxSoloShuffleRating   Int       @default(0)
  rbgShuffleRating       Int       @default(0)
  achievementPoints      Int       @default(0)
  raidProgress           String?
  weeklyKeysCompleted    Int       @default(0)
  weeklyBestKeyLevel     Int       @default(0)
  weeklySlot2KeyLevel    Int       @default(0)
  weeklySlot3KeyLevel    Int       @default(0)
  lastLoginTimestamp     BigInt?
  activityStatus         String    @default("inactive")
  lastActivityCheck      DateTime  @default(now())
  lastHourlyCheck        DateTime?
  characterApiUrl        String?
  lastUpdated            DateTime  @default(now())

  guild Guild @relation(fields: [guildId], references: [id], onDelete: Cascade)

  @@unique([guildId, characterName, realm])
  @@index([guildId, activityStatus])
  @@index([guildId, lastLoginTimestamp])
  @@map("guild_members")
}

model SyncJob {
  id               String    @id @default(cuid())
  guildId          String
  type             String
  status           String    @default("pending")
  bullmqJobId      String?
  totalItems       Int       @default(0)
  processedItems   Int       @default(0)
  errorCount       Int       @default(0)
  currentCharacter String?
  startedAt        DateTime?
  completedAt      DateTime?
  duration         Int?
  errorMessage     String?
  createdAt        DateTime  @default(now())

  guild Guild @relation(fields: [guildId], references: [id], onDelete: Cascade)

  @@index([guildId, status])
  @@index([guildId, createdAt])
  @@map("sync_jobs")
}

model SyncError {
  id            Int      @id @default(autoincrement())
  guildId       String
  characterName String
  realm         String?
  errorType     String
  errorMessage  String
  service       String
  urlAttempted  String?
  timestamp     DateTime @default(now())

  guild Guild @relation(fields: [guildId], references: [id], onDelete: Cascade)

  @@index([guildId, timestamp])
  @@map("sync_errors")
}

model SyncLog {
  id            Int      @id @default(autoincrement())
  guildId       String
  timestamp     DateTime @default(now())
  status        String
  message       String?
  characterName String?

  guild Guild @relation(fields: [guildId], references: [id], onDelete: Cascade)

  @@index([guildId])
  @@map("sync_logs")
}

// ============================================================================
// Growth / SEO content models
// ============================================================================

model Guide {
  id               String    @id @default(cuid())
  slug             String
  locale           String    @default("en") // en | fr
  status           String    @default("draft") // draft | published | retired | rewriting
  title            String
  metaTitle        String?
  metaDescription  String?
  content          String    @db.Text
  category         String // m-plus | pvp | raids | general | class-guides
  tags             String[] // ["mythic-plus", "season-1", ...]
  targetKeyword    String?
  relatedSlugs     String[]
  wordCount        Int       @default(0)
  dataSnapshot     Json? // real stats used in the article
  aiModel          String?
  aiCost           Float     @default(0)
  pageViews        Int       @default(0)
  bounceRate       Float     @default(0)
  qualityScore     Float     @default(0)
  publishedAt      DateTime?
  parentGuideId    String? // for translations â€” points to the "en" version
  contentPlanId    String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  parentGuide Guide?  @relation("GuideTranslations", fields: [parentGuideId], references: [id], onDelete: SetNull)
  translations Guide[] @relation("GuideTranslations")
  contentPlan ContentPlan? @relation(fields: [contentPlanId], references: [id], onDelete: SetNull)

  @@unique([slug, locale])
  @@index([status, locale])
  @@index([category])
  @@index([contentPlanId])
  @@map("guides")
}

model ContentPlan {
  id              String   @id @default(cuid())
  weekOf          DateTime @unique
  status          String   @default("pending") // pending | in_progress | completed
  strategy        String   @db.Text // JSON string of the AI plan
  totalBudgetUsed Float    @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  guides Guide[]

  @@map("content_plans")
}

model GrowthLog {
  id        String   @id @default(cuid())
  type      String // strategy | generation | review | analytics
  status    String // success | error | skipped
  message   String?
  metadata  Json?
  cost      Float    @default(0)
  duration  Int      @default(0) // seconds
  createdAt DateTime @default(now())

  @@index([type, createdAt])
  @@map("growth_logs")
}
